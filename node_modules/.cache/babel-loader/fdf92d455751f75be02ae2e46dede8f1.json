{"ast":null,"code":"import _objectSpread from \"/Users/chunfu/IdeaProjects/spatial-visual/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";\nimport _classCallCheck from \"/Users/chunfu/IdeaProjects/spatial-visual/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/chunfu/IdeaProjects/spatial-visual/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _get from \"/Users/chunfu/IdeaProjects/spatial-visual/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/get\";\nimport _getPrototypeOf from \"/Users/chunfu/IdeaProjects/spatial-visual/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"/Users/chunfu/IdeaProjects/spatial-visual/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nimport _createSuper from \"/Users/chunfu/IdeaProjects/spatial-visual/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";\nimport LayersPass from './layers-pass';\nimport { withParameters } from '@luma.gl/core';\nvar PICKING_PARAMETERS = {\n  blendFunc: [1, 0, 32771, 0],\n  blendEquation: 32774\n};\n\nvar PickLayersPass = /*#__PURE__*/function (_LayersPass) {\n  _inherits(PickLayersPass, _LayersPass);\n\n  var _super = _createSuper(PickLayersPass);\n\n  function PickLayersPass() {\n    _classCallCheck(this, PickLayersPass);\n\n    return _super.apply(this, arguments);\n  }\n\n  _createClass(PickLayersPass, [{\n    key: \"render\",\n    value: function render(props) {\n      if (props.pickingFBO) {\n        this.useAlpha = true;\n\n        this._drawPickingBuffer(props);\n      } else {\n        this.useAlpha = false;\n\n        _get(_getPrototypeOf(PickLayersPass.prototype), \"render\", this).call(this, props);\n      }\n    }\n  }, {\n    key: \"_drawPickingBuffer\",\n    value: function _drawPickingBuffer(_ref) {\n      var _this = this;\n\n      var layers = _ref.layers,\n          layerFilter = _ref.layerFilter,\n          views = _ref.views,\n          viewports = _ref.viewports,\n          onViewportActive = _ref.onViewportActive,\n          pickingFBO = _ref.pickingFBO,\n          _ref$deviceRect = _ref.deviceRect,\n          x = _ref$deviceRect.x,\n          y = _ref$deviceRect.y,\n          width = _ref$deviceRect.width,\n          height = _ref$deviceRect.height,\n          _ref$pass = _ref.pass,\n          pass = _ref$pass === void 0 ? 'picking' : _ref$pass,\n          redrawReason = _ref.redrawReason,\n          pickZ = _ref.pickZ;\n      var gl = this.gl;\n      this.pickZ = pickZ;\n      return withParameters(gl, _objectSpread(_objectSpread({\n        scissorTest: true,\n        scissor: [x, y, width, height],\n        clearColor: [0, 0, 0, 0],\n        depthMask: true,\n        depthTest: true,\n        depthRange: [0, 1],\n        colorMask: [true, true, true, true]\n      }, PICKING_PARAMETERS), {}, {\n        blend: !pickZ\n      }), function () {\n        _get(_getPrototypeOf(PickLayersPass.prototype), \"render\", _this).call(_this, {\n          target: pickingFBO,\n          layers: layers,\n          layerFilter: layerFilter,\n          views: views,\n          viewports: viewports,\n          onViewportActive: onViewportActive,\n          pass: pass,\n          redrawReason: redrawReason\n        });\n      });\n    }\n  }, {\n    key: \"shouldDrawLayer\",\n    value: function shouldDrawLayer(layer) {\n      return layer.props.pickable;\n    }\n  }, {\n    key: \"getModuleParameters\",\n    value: function getModuleParameters() {\n      return {\n        pickingActive: 1,\n        pickingAttribute: this.pickZ,\n        lightSources: {}\n      };\n    }\n  }, {\n    key: \"getLayerParameters\",\n    value: function getLayerParameters(layer, layerIndex) {\n      var pickParameters = this.pickZ ? {\n        blend: false\n      } : _objectSpread(_objectSpread({}, PICKING_PARAMETERS), {}, {\n        blend: true,\n        blendColor: [0, 0, 0, this.useAlpha ? (layerIndex + 1) / 255 : 1]\n      });\n      return _objectSpread(_objectSpread({}, layer.props.parameters), pickParameters);\n    }\n  }]);\n\n  return PickLayersPass;\n}(LayersPass);\n\nexport { PickLayersPass as default };","map":{"version":3,"sources":["../../../src/passes/pick-layers-pass.js"],"names":["PICKING_PARAMETERS","blendFunc","blendEquation","render","props","_drawPickingBuffer","deviceRect","height","pass","pickZ","gl","withParameters","scissorTest","scissor","clearColor","depthMask","depthTest","depthRange","colorMask","blend","target","layers","layerFilter","views","viewports","onViewportActive","redrawReason","shouldDrawLayer","layer","getModuleParameters","pickingActive","pickingAttribute","lightSources","getLayerParameters","pickParameters","blendColor","layerIndex"],"mappings":"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","sourcesContent":["import LayersPass from './layers-pass';\nimport {withParameters} from '@luma.gl/core';\nimport GL from '@luma.gl/constants';\n\nconst PICKING_PARAMETERS = {\n  blendFunc: [GL.ONE, GL.ZERO, GL.CONSTANT_ALPHA, GL.ZERO],\n  blendEquation: GL.FUNC_ADD\n};\n\nexport default class PickLayersPass extends LayersPass {\n  render(props) {\n    if (props.pickingFBO) {\n      // When drawing into an off-screen buffer, use the alpha channel to encode layer index\n      this.useAlpha = true;\n      this._drawPickingBuffer(props);\n    } else {\n      // When drawing to screen (debug mode), do not use the alpha channel so that result is always visible\n      this.useAlpha = false;\n      super.render(props);\n    }\n  }\n\n  // Private\n  // Draws list of layers and viewports into the picking buffer\n  // Note: does not sample the buffer, that has to be done by the caller\n  _drawPickingBuffer({\n    layers,\n    layerFilter,\n    views,\n    viewports,\n    onViewportActive,\n    pickingFBO,\n    deviceRect: {x, y, width, height},\n    pass = 'picking',\n    redrawReason,\n    pickZ\n  }) {\n    const gl = this.gl;\n    this.pickZ = pickZ;\n\n    // Make sure we clear scissor test and fbo bindings in case of exceptions\n    // We are only interested in one pixel, no need to render anything else\n    // Note that the callback here is called synchronously.\n    // Set blend mode for picking\n    // always overwrite existing pixel with [r,g,b,layerIndex]\n    return withParameters(\n      gl,\n      {\n        scissorTest: true,\n        scissor: [x, y, width, height],\n        clearColor: [0, 0, 0, 0],\n        // When used as Mapbox custom layer, the context state may be dirty\n        // TODO - Remove when mapbox fixes this issue\n        // https://github.com/mapbox/mapbox-gl-js/issues/7801\n        depthMask: true,\n        depthTest: true,\n        depthRange: [0, 1],\n        colorMask: [true, true, true, true],\n        // Blending\n        ...PICKING_PARAMETERS,\n        blend: !pickZ\n      },\n      () => {\n        super.render({\n          target: pickingFBO,\n          layers,\n          layerFilter,\n          views,\n          viewports,\n          onViewportActive,\n          pass,\n          redrawReason\n        });\n      }\n    );\n  }\n\n  // PRIVATE\n  shouldDrawLayer(layer) {\n    return layer.props.pickable;\n  }\n\n  getModuleParameters() {\n    return {\n      pickingActive: 1,\n      pickingAttribute: this.pickZ,\n      // turn off lighting by adding empty light source object\n      // lights shader module relies on the `lightSources` to turn on/off lighting\n      lightSources: {}\n    };\n  }\n\n  getLayerParameters(layer, layerIndex) {\n    // These will override any layer parameters\n    const pickParameters = this.pickZ\n      ? {blend: false}\n      : {\n          ...PICKING_PARAMETERS,\n          blend: true,\n          blendColor: [0, 0, 0, this.useAlpha ? (layerIndex + 1) / 255 : 1]\n        };\n\n    // Override layer parameters with pick parameters\n    return {\n      ...layer.props.parameters,\n      ...pickParameters\n    };\n  }\n}\n"]},"metadata":{},"sourceType":"module"}